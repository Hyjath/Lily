'OBSERVERA ATT KODEN I DENNA KLASS ÄR EN DEL AV GRUNDDATABASEN OCH FÅR INTE ÄNDRAS.
'ÄNDRINGAR OCH TILLÄGG I FUNKTIONALITET GÖRS I SEPARATA KLASSER OCH MODULER.
'OM DU TROTS DETTA VÄLJER ATT GÖRA ÄNDRINGAR I KODEN NEDAN GARANTERAS INTE LÄNGRE
'VERSIONS KOMPABILITET ELLER SUPPORT. //Projektgruppen LEAN
Option Explicit


Public Function NewHistory(ByVal sHistoryType As String, Optional ByVal sNote As String)
    On Error GoTo ErrorHandler
    Dim oInspector As Lime.Inspector
    
    Set oInspector = Application.ActiveInspector
    
    If Globals.VerifyInspector("company", oInspector) Then
        If (oInspector.Record.State And lkRecordStateNew) = lkRecordStateNew Then
            On Error GoTo ErrorSaving
                'Call oInspector.Controls.Validate
                oInspector.Save (True)
            GoTo SaveOK
ErrorSaving:
                Call Lime.MessageBox(Err.Description)
                Exit Function
SaveOK:
        End If
    End If
    
    Dim oRecord As New LDE.Record
    Dim oNewInspector As Lime.Inspector
    Dim sFocusField As String
    
    sFocusField = "person"
    
    oRecord.Open Database.Classes("history")
        Call oRecord.SelectOption("type", sHistoryType)
    If VBA.IsMissing(sNote) = False Then
        oRecord.Value("note") = sNote
    End If
    oRecord.Value("company") = oInspector.Record.ID
    
    'Försök att leta upp personen för att ev. sätta den också
    If Not oInspector.ActiveExplorer Is Nothing Then
        If oInspector.ActiveExplorer.Class.Name = "person" Then
            If oInspector.Explorers("person").Selection.Count = 1 Then
                If Lime.MessageBox(Localize.GetText("Actionpad_Company", "q_connect_person"), VBA.vbQuestion Or VBA.vbYesNo, oInspector.Explorers("person").Selection(1).Record.Description) = VBA.vbYes Then
                    oRecord.Value("person") = oInspector.Explorers("person").Selection(1).Record.ID
                    sFocusField = "note"
                End If
            End If
        End If
    End If
        
    Set oNewInspector = Lime.OpenInspector(oInspector, oRecord, lkActivateExisting)
    'Set Focus to the correct field
    Set oNewInspector.Controls.ActiveControl = oNewInspector.Controls(sFocusField)
    If oNewInspector.Controls.GetValue("done", 0) = 1 And VBA.Len(VBA.Trim(sNote)) = 0 Then
        Call oNewInspector.Controls.SetValue("note", "")
    End If
        
    
    Exit Function
ErrorHandler:
    Call UI.ShowError("Actionpad_Company.NewHistory")
End Function
